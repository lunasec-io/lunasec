/*
 * Copyright by LunaSec (owned by Refinery Labs, Inc)
 *
 * Licensed under the Business Source License v1.1
 * (the "License"); you may not use this file except in compliance with the
 * License. You may obtain a copy of the License at
 *
 * https://github.com/lunasec-io/lunasec/blob/master/licenses/BSL-LunaTrace.txt
 *
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 */
import { findingIsNotIgnored } from '@lunatrace/lunatrace-common/build/main';
import classNames from 'classnames';
import React, { useState } from 'react';
import { FloatingLabel, Form, FormControl, OverlayTrigger, Spinner, Tooltip } from 'react-bootstrap';
import { XSquare } from 'react-feather';
import { useParams } from 'react-router-dom';

import api from '../../../../api';
import { ConfirmationDailog } from '../../../../components/ConfirmationDialog';
import { CvssInferredWarning } from '../../../../components/CvssInferredWarning';

import { Finding } from './types';

interface VulnerabilityTableItemProps {
  finding: Finding;
  setVulnQuickViewId: (vulnId: string) => void;
  vulnQuickViewId: string | null;
}

export const VulnerabilityTableItem: React.FC<VulnerabilityTableItemProps> = ({
  finding,
  setVulnQuickViewId,
  vulnQuickViewId,
}) => {
  const [insertVulnIgnore, insertVulnIgnoreState] = api.useInsertIgnoredVulnerabilitiesMutation();
  const { project_id } = useParams();

  const [showConfirmation, setShowConfirmation] = useState(false);
  const [ignoreNote, setIgnoreNote] = useState('');

  const findingIsIgnored = !findingIsNotIgnored(finding);

  const ignoreVuln = async () => {
    await insertVulnIgnore({
      objects: [
        {
          project_id: project_id,
          vulnerability_id: finding.vulnerability_id,
          note: ignoreNote,
          locations: finding.locations,
        },
      ],
    });
    setIgnoreNote('');
  };

  const getIgnoreColumn = () => {
    if (findingIsIgnored) {
      return finding.vulnerability.ignored_vulnerabilities[0].note || 'ignored';
    }

    if (insertVulnIgnoreState.isLoading) {
      return <Spinner size="sm" animation="border" />;
    }
    return (
      <XSquare
        className="ignore-vuln-button"
        onClick={(e) => {
          e.stopPropagation();
          setShowConfirmation(true);
        }}
      />
    );
  };

  return (
    <>
      <OverlayTrigger
        placement="bottom"
        overlay={<Tooltip className="wide-tooltip"> {finding.vulnerability.description}</Tooltip>}
        key={finding.id}
      >
        <tr
          style={{ cursor: 'pointer' }}
          onClick={(e) => {
            setVulnQuickViewId(finding.vulnerability_id as string);
          }}
          className={classNames('vuln-table-item', { open: vulnQuickViewId === finding.vulnerability_id })}
          key={finding.id}
        >
          <td>{finding.vulnerability.namespace}</td>
          <td>{finding.vulnerability.name}</td>
          <td>{finding.severity}</td>
          <td>
            {finding.vulnerability.cvss_score}{' '}
            <CvssInferredWarning inferred={finding.vulnerability.cvss_inferred || false} placement="top" />{' '}
          </td>
          <td>{finding.fix_versions || 'unknown'}</td>
          <td>{getIgnoreColumn()}</td>
        </tr>
      </OverlayTrigger>
      <ConfirmationDailog
        title={`Ignore Finding`}
        body={(
          <>
            <p>
              Whenever this vulnerability is found in this project, it will be ignored. If it is found at a different
              location the project (ex. a different manifest file) it will appear again. The ability to undo this choice
              is coming in a future update.
            </p>
            <Form
              onSubmit={(e) => {
                e.preventDefault();
                setShowConfirmation(false);
                void ignoreVuln();
              }}
            >
              <FloatingLabel controlId="floatingInput" label="Reason (optional)" className="mb-3">
                <FormControl
                  value={ignoreNote}
                  onChange={(e) => setIgnoreNote(e.target.value)}
                  required={false}
                  placeholder="Enter reason"
                />
              </FloatingLabel>
            </Form>
          </>
        )}
        onClose={(success) => {
          setShowConfirmation(false);
          if (success) {
            void ignoreVuln();
          }
        }}
        show={showConfirmation}
      />
    </>
  );
};
